# ADR 0001: 采用多线程架构分离 UI 渲染与事件处理 (最终版)

*   **状态**: 已合并 (Merged into ADR 0005)
*   **日期**: 2026-01-04
*   **作者**: Gemini, Libo

## 1. 背景 (Context)

当前的单线程主循环架构将 UI 渲染、I/O 操作和事件监听紧密耦合，导致 UI 流畅度、输入响应性和系统资源利用率均存在瓶颈。为解决此问题，我们寻求一个更健壮、解耦的架构，以保证“事件不丢失”（在系统能力范围内）和流畅的动画体验。

## 2. 设计选项评估 (Design Options)

为实现线程间的事件传递，我们评估了以下几种队列方案：

### 方案 A: 使用 `pipe` 或 `socketpair`

*   **描述**: 利用内核提供的 IPC 机制。主线程向管道写入事件，UI 线程从管道读取。
*   **优点**: 内核级实现，线程安全，可与 `poll`/`epoll` 无缝集成。
*   **缺点**: 当管道缓冲区满时，`write()` 会**阻塞主线程**，影响输入响应，这与我们的高响应性目标相悖。
*   **评估**: 不采纳。

### 方案 B: 无锁队列 (Lock-Free Queue)

*   **描述**: 使用 C11/C++11 的原子操作 (`atomic_*`) 实现环形缓冲区。
*   **优点**: 性能极致，无锁竞争开销。
*   **缺点**: 实现极其复杂，尤其是在保证内存序（Memory Order）方面，非常容易出错。对于本项目的“单生产者-单消费者”场景属于过度设计。
*   **评估**: 不采纳。

### 方案 C: 基于互斥锁+条件变量的环形缓冲区

*   **描述**: 自行实现一个线程安全的、有界的环形缓冲区。
*   **优点**: 行为可控（可实现不阻塞的溢出策略）、实现清晰、无需外部依赖。
*   **缺点**: 存在锁开销，但在低频 UI 事件场景下可忽略。
*   **评估**: **采纳**。这是平衡性能、实现难度和项目需求的最佳方案。

## 3. 决策 (Decision)

我们决定采用**双线程、事件驱动模型**的架构，其核心是**基于互斥锁和条件变量的有界环形缓冲区事件队列**。

1.  **双线程职责划分**: 
    *   **主线程 (事件生产者)**: 专职监听外部事件（GPIO、`timerfd`、`eventfd`），并将事件推入队列。
    *   **UI 线程 (事件消费者)**: 专职从队列消费事件、更新 UI 状态，并管理所有 `u8g2` 渲染及 I2C 通信。

2.  **事件不丢失语义**:
    *   在事件队列未溢出的前提下，保证所有事件都能被消费，实现“事件不丢失”。
    *   **溢出策略**: 当队列已满时，新的事件将**覆盖最旧的未处理事件**，并记录一条警告日志。此策略优先保障系统对最新操作的响应。

3.  **线程唤醒与退出机制**:
    *   **唤醒**: 主线程推入事件后，通过 `pthread_cond_signal()` **唯一**地唤醒 UI 线程。
    *   **退出**: 通过一个专用的 `eventfd` 通知主线程 `poll` 循环退出，主线程在退出前调用 `pthread_cond_broadcast()` 确保 UI 线程也能被唤醒并检查退出标志，从而实现优雅停机。

## 4. 后果 (Consequences)

### 优势 (Pros)

1.  **高响应性**: 事件队列确保了用户的操作被即时捕获。
2.  **流畅的 UI**: UI 线程独立运行，可实现高帧率、时间精准的动画。
3.  **高效的 CPU 利用**: 线程在空闲时都处于高效休眠状态。
4.  **清晰的架构与线程安全**: 严格的职责划分和明确的通信机制，降低了并发风险。

### 劣势 (Cons)

1.  **增加复杂性**: 引入了 `pthreads`、并发数据结构等，对开发要求更高。
2.  **调试难度**: 多线程应用的调试比单线程更复杂。

## 5. 实施要点 (Implementation Notes)

*   **事件队列实现**:
    *   应包含一个固定大小的事件数组、`head` 和 `tail` 指针、一个互斥锁和一个条件变量 (`cond_not_empty`)。
    *   `push` 操作需处理 `head` 指针前移以实现覆盖逻辑。
    *   `pop` 操作在队列为空时需调用 `pthread_cond_wait` 等待。
*   **线程所有权**:
    *   **主线程**: 拥有 `sysfs` (GPIO)、`timerfd` 和 `eventfd` 的文件描述符。
    *   **UI 线程**: 拥有所有 `u8g2` 资源和 I2C 设备文件描述符。任何 `u8g2_*` 函数都严禁在主线程调用。
*   **定时器**: 主线程使用的 `timerfd` 必须基于 `CLOCK_MONOTONIC` 创建，以避免受系统时间变更影响。

## 6. 相关决策 (Related ADRs)

*   ADR 0002: 单线程节拍驱动主循环（当前版本采用的替代方案）
*   ADR 0003: ubus 后台工作线程（在单线程节拍基础上的局部并发优化）

---
这份最终版的 ADR 为重构工作提供了清晰、严谨且权衡了多种方案的工程蓝图。
